<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>18.3. Multiple and Virtual Inheritance</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" type="text/css" rel="stylesheet"/>
<link href="page_styles.css" type="text/css" rel="stylesheet"/>
</head>
  <body class="calibre">
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="001-contents.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href="172-18.2._namespaces.html"><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href="174-chapter_summary.html"><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a></div></td></tr></table><h3 id="filepos5026780" class="calibre29"><span class="bold">18.3. Multiple and Virtual Inheritance</span></h3><div class="calibre12">&#160;</div>
<p class="calibre14"><strong class="calibre5"><a id="filepos5026929" href="175-defined_terms.html#filepos5110729">Multiple inheritance</a></strong> is the ability to derive a class from more than one direct base class (&#167; <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">15.2.2</a>, p. <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">600</a>). A multiply derived class inherits the properties of all its parents. Although simple in concept, the details of intertwining multiple base classes can present tricky design-level and implementation-level problems.</p><div class="calibre15">&#160;</div>
<p class="calibre25">To explore multiple inheritance, we&#8217;ll use a pedagogical example of a zoo animal hierarchy. Our zoo animals exist at different levels of abstraction. There are the individual animals, distinguished by their names, such as Ling-ling, Mowgli, and Balou. Each animal belongs to a species; Ling-Ling, for example, is a giant <a id="filepos5027759"/>panda. Species, in turn, are members of families. A giant panda is a member of the bear family. Each family, in turn, is a member of the animal kingdom&#8212;in this case, the more limited kingdom of a particular zoo.</p><div class="calibre22">&#160;</div>
<p class="calibre25">We&#8217;ll define an abstract <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> class to hold information that is common to all the zoo animals and provides the most general interface. The <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> class will contain information that is unique to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> family, and so on.</p><div class="calibre22">&#160;</div>
<p class="calibre25">In addition to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> classes, our application will contain auxiliary classes that encapsulate various abstractions such as endangered animals. In our implementation of a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> class, for example, a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> is multiply derived from <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code>.</p><div class="calibre22">&#160;</div>
<h4 id="filepos5029133" class="calibre37"><span class="calibre5">18.3.1. Multiple Inheritance</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">The derivation list in a derived class can contain more than one base class:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class Bear : public ZooAnimal {<br class="calibre6"/>class Panda : public Bear, public Endangered { /* ... */ };</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">Each base class has an optional access specifier (&#167; <a href="146-15.5._access_control_and_inheritance.html#filepos3901534">15.5</a>, p. <a href="146-15.5._access_control_and_inheritance.html#filepos3901534">612</a>). As usual, if the access specifier is omitted, the specifier defaults to <code class="calibre23"><tt class="calibre23"><span class="calibre24">private</span></tt></code> if the <code class="calibre23"><tt class="calibre23"><span class="calibre24">class</span></tt></code> keyword is used and to <code class="calibre23"><tt class="calibre23"><span class="calibre24">public</span></tt></code> if <code class="calibre23"><tt class="calibre23"><span class="calibre24">struct</span></tt></code> is used (&#167; <a href="146-15.5._access_control_and_inheritance.html#filepos3901534">15.5</a>, p. <a href="146-15.5._access_control_and_inheritance.html#filepos3901534">616</a>).</p><div class="calibre15">&#160;</div>
<p class="calibre25">As with single inheritance, the derivation list may include only classes that have been defined and that were not defined as <code class="calibre23"><tt class="calibre23"><span class="calibre24">final</span></tt></code> (&#167; <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">15.2.2</a>, p. <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">600</a>). There is no language-imposed limit on the number of base classes from which a class can be derived. A base class may appear only once in a given derivation list.</p><div class="calibre22">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Multiply Derived Classes Inherit State from Each Base Class</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">Under multiple inheritance, an object of a derived class contains a subobject for each of its base classes (&#167; <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">15.2.2</a>, p. <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">597</a>). For example, as illustrated in <a href="173-18.3._multiple_and_virtual_inheritance.html#filepos5031930">Figure 18.2</a>, a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object has a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> part (which itself contains a <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> part), an <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> class part, and the non<code class="calibre23"><tt class="calibre23"><span class="calibre24">static</span></tt></code> data members, if any, declared within the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> class.</p><div class="calibre15">&#160;</div>
<div class="calibre52"><a id="filepos5031930"/><img alt="Image" src="images/00133.jpg" class="calibre9"/></div><div class="calibre22">&#160;</div>
<p class="calibre51"><span class="calibre5">Figure 18.2. Conceptual Structure of a <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Panda</span></span></tt></span></span></tt></code> Object</span></p><div class="calibre12">&#160;</div>
<h5 class="calibre39"><span class="calibre5"><a id="filepos5032290"/>Derived Constructors Initialize All Base Classes</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">Constructing an object of derived type constructs and initializes all its base subobjects. As is the case for inheriting from a single base class (&#167; <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">15.2.2</a>, p. <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">598</a>), a derived type&#8217;s constructor initializer may initialize only its direct base classes:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">// <span><span class="calibre45"><span class="calibre16">explicitly initialize both base classes</span></span></span><br class="calibre6"/>Panda::Panda(std::string name, bool onExhibit)<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;: Bear(name, onExhibit, "Panda"),<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Endangered(Endangered::critical) { }<br class="calibre6"/>// <span><span class="calibre45"><span class="calibre16">implicitly uses the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Bear</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">default constructor to initialize the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Bear</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">subobject</span></span></span><br class="calibre6"/>Panda::Panda()<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;: Endangered(Endangered::critical) { }</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">The constructor initializer list may pass arguments to each of the direct base classes. The order in which base classes are constructed depends on the order in which they appear in the class derivation list. The order in which they appear in the constructor initializer list is irrelevant. A <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object is initialized as follows:</p><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>, the ultimate base class up the hierarchy from <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code>&#8217;s first direct base class, <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code>, is initialized first.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code>, the first direct base class, is initialized next.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code>, the second direct base, is initialized next.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code>, the most derived part, is initialized last.</p></blockquote><div class="calibre15">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Inherited Constructors and Multiple Inheritance</span></h5><div class="calibre38">&#160;</div>
<div class="calibre28"><a id="filepos5035521"/><img alt="Image" src="images/00008.jpg" class="calibre9"/></div>
<p class="calibre14">Under the new standard, a derived class can inherit its constructors from one or more of its base classes (&#167; <a href="148-15.7._constructors_and_copy_control.html#filepos4009689">15.7.4</a>, p. <a href="148-15.7._constructors_and_copy_control.html#filepos4009689">628</a>). It is an error to inherit the same constructor (i.e., one with the same parameter list) from more than one base class:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">struct Base1 {<br class="calibre6"/>&#160;&#160;&#160;&#160;Base1() = default;<br class="calibre6"/>&#160;&#160;&#160;&#160;Base1(const std::string&amp;);<br class="calibre6"/>&#160;&#160;&#160;&#160;Base1(std::shared_ptr&lt;int&gt;);<br class="calibre6"/>};<br class="calibre6"/><br class="calibre6"/>struct Base2 {<br class="calibre6"/>&#160;&#160;&#160;&#160;Base2() = default;<br class="calibre6"/>&#160;&#160;&#160;&#160;Base2(const std::string&amp;);<br class="calibre6"/>&#160;&#160;&#160;&#160;Base2(int);<br class="calibre6"/>};<br class="calibre6"/><br class="calibre6"/>// <span><span class="calibre45"><span class="calibre16">error:</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">D1</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">attempts to inherit</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">D1::D1 (const string&amp;</span></span></tt></span>) <span><span class="calibre45"><span class="calibre16">from both base classes</span></span></span><br class="calibre6"/>struct D1: public Base1, public Base2 {<br class="calibre6"/>&#160;&#160;&#160;&#160;using Base1::Base1;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">inherit constructors from</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Base1</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;using Base2::Base2;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">inherit constructors from</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Base2</span></span></tt></span><br class="calibre6"/>};</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">A class that inherits the same constructor from more than one base class must define its own version of that constructor:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"><a id="filepos5037740"/></span></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">struct D2: public Base1, public Base2 {<br class="calibre6"/>&#160;&#160;&#160;&#160;using Base1::Base1;&#160;&#160;//<span><span class="calibre45"><span class="calibre16">&#160;&#160;inherit constructors from</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Base1</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;using Base2::Base2;&#160;&#160;//<span><span class="calibre45"><span class="calibre16">&#160;&#160;inherit constructors from</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Base2</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">D2</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">must define its own constructor that takes a</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">string</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;D2(const string &amp;s): Base1(s), Base2(s) { }<br class="calibre6"/>&#160;&#160;&#160;&#160;D2() = default; // <span><span class="calibre45"><span class="calibre16">needed once</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">D2</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">defines its own constructor</span></span></span><br class="calibre6"/>};</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Destructors and Multiple Inheritance</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">As usual, the destructor in a derived class is responsible for cleaning up resources allocated by that class only&#8212;the members and all the base class(es) of the derived class are automatically destroyed. The synthesized destructor has an empty function body.</p><div class="calibre15">&#160;</div>
<p class="calibre25">Destructors are always invoked in the reverse order from which the constructors are run. In our example, the order in which the destructors are called is <code class="calibre23"><tt class="calibre23"><span class="calibre24">~Panda</span></tt></code>, <code class="calibre23"><tt class="calibre23"><span class="calibre24">~Endangered</span></tt></code>, <code class="calibre23"><tt class="calibre23"><span class="calibre24">~Bear</span></tt></code>, <code class="calibre23"><tt class="calibre23"><span class="calibre24">~ZooAnimal</span></tt></code>.</p><div class="calibre22">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Copy and Move Operations for Multiply Derived Classes</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">As is the case for single inheritance, classes with multiple bases that define their own copy/move constructors and assignment operators must copy, move, or assign the whole object (&#167; <a href="148-15.7._constructors_and_copy_control.html#filepos3980968">15.7.2</a>, p. <a href="148-15.7._constructors_and_copy_control.html#filepos3980968">623</a>). The base parts of a multiply derived class are automatically copied, moved, or assigned only if the derived class uses the synthesized versions of these members. In the synthesized copy-control members, each base class is implicitly constructed, assigned, or destroyed, using the corresponding member from that base class.</p><div class="calibre15">&#160;</div>
<p class="calibre25">For example, assuming that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> uses the synthesized members, then the initialization of <code class="calibre23"><tt class="calibre23"><span class="calibre24">ling_ling</span></tt></code>:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Panda ying_yang("ying_yang");<br class="calibre6"/>Panda ling_ling = ying_yang;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">uses the copy constructor</span></span></span></span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">will invoke the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> copy constructor, which in turn runs the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> copy constructor before executing the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> copy constructor. Once the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> portion of <code class="calibre23"><tt class="calibre23"><span class="calibre24">ling_ling</span></tt></code> is constructed, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> copy constructor is run to create that part of the object. Finally, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> copy constructor is run. Similarly, for the synthesized move constructor.</p><div class="calibre15">&#160;</div>
<p class="calibre25">The synthesized copy-assignment operator behaves similarly to the copy constructor. It assigns the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> (and through <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code>, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>) parts of the object first. Next, it assigns the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> part, and finally the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> part. Move assignment behaves similarly.</p><div class="calibre22">&#160;</div>
<h4 id="filepos5043117" class="calibre37"><span class="calibre5">18.3.2. Conversions and Multiple Base Classes</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">Under single inheritance, a pointer or a reference to a derived class can be converted automatically to a pointer or a reference to an accessible base class (&#167; <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">15.2.2</a>, p. <a href="143-15.2._defining_base_and_derived_classes.html#filepos3806030">597</a>, and &#167; <a href="146-15.5._access_control_and_inheritance.html#filepos3901534">15.5</a>, p. <a href="146-15.5._access_control_and_inheritance.html#filepos3901534">613</a>). The same holds true with multiple inheritance. A pointer or reference to any of an object&#8217;s (accessible) base classes can be used to point or <a id="filepos5043731"/>refer to a derived object. For example, a pointer or reference to <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>, <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code>, or <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> can be bound to a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">// <span><span class="calibre45"><span class="calibre16">operations that take references to base classes of type</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda</span></span></tt></span><br class="calibre6"/>void print(const Bear&amp;);<br class="calibre6"/>void highlight(const Endangered&amp;);<br class="calibre6"/>ostream&amp; operator&lt;&lt;(ostream&amp;, const ZooAnimal&amp;);<br class="calibre6"/><br class="calibre6"/>Panda ying_yang("ying_yang");<br class="calibre6"/><br class="calibre6"/>print(ying_yang);&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">passes</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to a reference to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Bear</span></span></tt></span><br class="calibre6"/>highlight(ying_yang); // <span><span class="calibre45"><span class="calibre16">passes</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to a reference to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Endangered</span></span></tt></span><br class="calibre6"/>cout &lt;&lt; ying_yang &lt;&lt; endl; // <span><span class="calibre45"><span class="calibre16">passes</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to a reference to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">ZooAnimal</span></span></tt></span></span></tt></p></blockquote><div class="calibre22">&#160;</div>
<div class="calibre42"><blockquote class="calibre26"><hr class="calibre34"/><blockquote class="calibre13"><p class="calibre43"><span class="calibre5">Exercises Section 18.3.1</span></p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.21:</strong> Explain the following declarations. Identify any that are in error and explain why they are incorrect:</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(a)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">class CADVehicle : public CAD, Vehicle { ... };</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(b)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">class DblList: public List, public List { ... };</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(c)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">class iostream: public istream, public ostream { ... };</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a id="filepos5046969"/><strong class="calibre5">Exercise 18.22:</strong> Given the following class hierarchy, in which each class defines a default constructor:</p></blockquote><div class="calibre10">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class A { ... };<br class="calibre6"/>class B : public A { ... };<br class="calibre6"/>class C : public B { ... };<br class="calibre6"/>class X { ... };<br class="calibre6"/>class Y { ... };<br class="calibre6"/>class Z : public X, public Y { ... };<br class="calibre6"/>class MI : public C, public Z { ... };</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">what is the order of constructor execution for the following definition?</p><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">MI mi;</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<p class="calibre25">The compiler makes no attempt to distinguish between base classes in terms of a derived-class conversion. Converting to each base class is equally good. For example, if there was an overloaded version of <code class="calibre23"><tt class="calibre23"><span class="calibre24">print</span></tt></code>:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">void print(const Bear&amp;);<br class="calibre6"/>void print(const Endangered&amp;);</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">an unqualified call to <code class="calibre23"><tt class="calibre23"><span class="calibre24">print</span></tt></code> with a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object would be a compile-time error:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Panda ying_yang("ying_yang");<br class="calibre6"/>print(ying_yang);&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">error: ambiguous</span></span></span></span></tt></p></blockquote><div class="calibre22">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Lookup Based on Type of Pointer or Reference</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">As with single inheritance, the static type of the object, pointer, or reference determines which members we can use (&#167; <a href="147-15.6._class_scope_under_inheritance.html#filepos3941072">15.6</a>, p. <a href="147-15.6._class_scope_under_inheritance.html#filepos3941072">617</a>). If we use a <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> pointer, <a id="filepos5049855"/>only the operations defined in that class are usable. The <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code>-specific, <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda-</span></tt></code>specific, and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> portions of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> interface are invisible. Similarly, a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> pointer or reference knows only about the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> members; an <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> pointer or reference is limited to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> members.</p><div class="calibre15">&#160;</div>
<p class="calibre25">As an example, consider the following calls, which assume that our classes define the virtual functions listed in <a href="173-18.3._multiple_and_virtual_inheritance.html#filepos5054351">Table 18.1</a>:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Bear *pb = new Panda("ying_yang");<br class="calibre6"/><br class="calibre6"/>pb-&gt;print();&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">ok:</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda::print()</span></span></tt></span><br class="calibre6"/>pb-&gt;cuddle();&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">error: not part of the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Bear</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">interface</span></span></span><br class="calibre6"/>pb-&gt;highlight();&#160;&#160;// <span><span class="calibre45"><span class="calibre16">error: not part of the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Bear</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">interface</span></span></span><br class="calibre6"/>delete pb;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">ok:</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda::~Panda(</span></span></tt></span>)</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre25">When a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> is used via an <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> pointer or reference, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda-</span></tt></code>specific and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> portions of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> interface are invisible:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Endangered *pe = new Panda("ying_yang");<br class="calibre6"/>pe-&gt;print();&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">ok:</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda::print()</span></span></tt></span><br class="calibre6"/>pe-&gt;toes();&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">error: not part of the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Endangered</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">interface</span></span></span><br class="calibre6"/>pe-&gt;cuddle();&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">error: not part of the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Endangered</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">interface</span></span></span><br class="calibre6"/>pe-&gt;highlight(); // <span><span class="calibre45"><span class="calibre16">ok:</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda::highlight()</span></span></tt></span><br class="calibre6"/>delete pe;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">ok:</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda::~Panda(</span></span></tt></span>)</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre51"><span class="calibre5"><a id="filepos5054351"/>Table 18.1. Virtual Functions in the <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">ZooAnimal/Endangered</span></span></tt></span></span></tt></code> Classes</span></p><div class="calibre12">&#160;</div>
<div class="calibre52"><img alt="Image" src="images/00134.jpg" class="calibre9"/></div><div class="calibre22">&#160;</div>
<h4 id="filepos5054669" class="calibre37"><span class="calibre5">18.3.3. Class Scope under Multiple Inheritance</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">Under single inheritance, the scope of a derived class is nested within the scope of its direct and indirect base classes (&#167; <a href="147-15.6._class_scope_under_inheritance.html#filepos3941072">15.6</a>, p. <a href="147-15.6._class_scope_under_inheritance.html#filepos3941072">617</a>). Lookup happens by searching up the inheritance hierarchy until the given name is found. Names defined in a derived class hide uses of that name inside a base.</p><div class="calibre15">&#160;</div>
<p class="calibre25">Under multiple inheritance, this same lookup happens <em class="calibre16">simultaneously</em> among all the direct base classes. If a name is found through more than one base class, then use of that name is ambiguous.</p><div class="calibre22">&#160;</div>
<div class="calibre42"><blockquote class="calibre26"><a id="filepos5055497"/><hr class="calibre34"/><blockquote class="calibre13"><p class="calibre43"><span class="calibre5">Exercises Section 18.3.2</span></p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.23:</strong> Using the hierarchy in <a href="173-18.3._multiple_and_virtual_inheritance.html#filepos5046969">exercise 18.22</a> along with class <code class="calibre23"><tt class="calibre23"><span class="calibre24">D</span></tt></code> defined below, and assuming each class defines a default constructor, which, if any, of the following conversions are not permitted?</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class D : public X, public C { ... };<br class="calibre6"/>D *pd = new D;</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(a)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">X *px = pd;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(b)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">A *pa = pd;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(c)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">B *pb = pd;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(d)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">C *pc = pd;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.24:</strong> On page <a href="173-18.3._multiple_and_virtual_inheritance.html#filepos5049855">807</a> we presented a series of calls made through a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> pointer that pointed to a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object. Explain each call assuming we used a <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> pointer pointing to a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object instead.</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.25:</strong> Assume we have two base classes, <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base1</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base2</span></tt></code>, each of which defines a virtual member named <code class="calibre23"><tt class="calibre23"><span class="calibre24">print</span></tt></code> and a virtual destructor. From these base classes we derive the following classes, each of which redefines the <code class="calibre23"><tt class="calibre23"><span class="calibre24">print</span></tt></code> function:</p></blockquote><div class="calibre10">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class D1 : public Base1 { /* ... */ };<br class="calibre6"/>class D2 : public Base2 { /* ... */ };<br class="calibre6"/>class MI : public D1, public D2 { /* ... */ };</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">Using the following pointers, determine which function is used in each call:</p><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Base1 *pb1 = new MI;<br class="calibre6"/>Base2 *pb2 = new MI;<br class="calibre6"/>D1 *pd1 = new MI;<br class="calibre6"/>D2 *pd2 = new MI;</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(a)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">pb1-&gt;print();</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(b)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">pd1-&gt;print();</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(c)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">pd2-&gt;print();</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(d)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">delete pb2;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(e)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">delete pd1;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(f)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">delete pd2;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<p class="calibre25">In our example, if we use a name through a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object, pointer, or reference, both the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> and the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear/ZooAnimal</span></tt></code> subtrees are examined in parallel. If the name is found in more than one subtree, then the use of the name is ambiguous. It is perfectly legal for a class to inherit multiple members with the same name. However, if we want to use that name, we must specify which version we want to use.</p><div class="calibre22">&#160;</div>
<div class="calibre33"><blockquote class="calibre26"><hr class="calibre34"/><p class="calibre14"><span class="calibre5"><a/><img alt="Image" src="images/00013.jpg" class="calibre9"/> Warning</span></p><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre14">When a class has multiple base classes, it is possible for that derived class to inherit a member with the same name from two or more of its base classes. Unqualified uses of that name are ambiguous.</p></blockquote><div class="calibre22">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<p class="calibre25">For example, if both <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code> define a member named <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code>, and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> does not define that member, this call is an error:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">double d = ying_yang.max_weight();</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">The derivation of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code>, which results in <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> having two members named <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code>, is perfectly legal. The derivation generates a <em class="calibre16">potential</em> ambiguity. That ambiguity is avoided if no <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object ever calls <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code>. The error <a id="filepos5062722"/>would also be avoided if each call to <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code> specifically indicated which version to run&#8212;<code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal::max_weight</span></tt></code> or <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered::max_weight</span></tt></code>. An error results only if there is an ambiguous attempt to use the member.</p><div class="calibre15">&#160;</div>
<p class="calibre25">The ambiguity of the two inherited <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code> members is reasonably obvious. It might be more surprising to learn that an error would be generated even if the two inherited functions had different parameter lists. Similarly, it would be an error even if the <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code> function were <code class="calibre23"><tt class="calibre23"><span class="calibre24">private</span></tt></code> in one class and <code class="calibre23"><tt class="calibre23"><span class="calibre24">public</span></tt></code> or <code class="calibre23"><tt class="calibre23"><span class="calibre24">protected</span></tt></code> in the other. Finally, if <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code> were defined in <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and not in <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>, the call would still be in error.</p><div class="calibre22">&#160;</div>
<p class="calibre25">As always, name lookup happens before type checking (&#167; <a href="066-6.4._overloaded_functions.html#filepos1621309">6.4.1</a>, p. <a href="066-6.4._overloaded_functions.html#filepos1621309">234</a>). When the compiler finds <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code> in two different scopes, it generates an error noting that the call is ambiguous.</p><div class="calibre22">&#160;</div>
<p class="calibre25">The best way to avoid potential ambiguities is to define a version of the function in the derived class that resolves the ambiguity. For example, we should give our <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> class a <code class="calibre23"><tt class="calibre23"><span class="calibre24">max_weight</span></tt></code> function that resolves the ambiguity:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">double Panda::max_weight() const<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;return std::max(ZooAnimal::max_weight(),<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Endangered::max_weight());<br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<div class="calibre42"><blockquote class="calibre26"><hr class="calibre34"/><blockquote class="calibre13"><p class="calibre43"><span class="calibre5">Exercises Section 18.3.3</span></p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.26:</strong> Given the hierarchy in the box on page <a href="173-18.3._multiple_and_virtual_inheritance.html#filepos5068799">810</a>, why is the following call to <code class="calibre23"><tt class="calibre23"><span class="calibre24">print</span></tt></code> an error? Revise <code class="calibre23"><tt class="calibre23"><span class="calibre24">MI</span></tt></code> to allow this call to <code class="calibre23"><tt class="calibre23"><span class="calibre24">print</span></tt></code> to compile and execute correctly.</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">MI mi;<br class="calibre6"/>mi.print(42);</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.27:</strong> Given the class hierarchy in the box on page <a href="173-18.3._multiple_and_virtual_inheritance.html#filepos5068799">810</a> and assuming we add a function named <code class="calibre23"><tt class="calibre23"><span class="calibre24">foo</span></tt></code> to MI as follows:</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">int ival;<br class="calibre6"/>double dval;<br class="calibre6"/><br class="calibre6"/>void MI::foo(double cval)<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;int dval;<br class="calibre6"/>&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">exercise questions occur here</span></span></span><br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(a)</strong> List all the names visible from within <code class="calibre23"><tt class="calibre23"><span class="calibre24">MI::foo</span></tt></code>.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(b)</strong> Are any names visible from more than one base class?</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(c)</strong> Assign to the local instance of <code class="calibre23"><tt class="calibre23"><span class="calibre24">dval</span></tt></code> the sum of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">dval</span></tt></code> member of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base1</span></tt></code> and the <code class="calibre23"><tt class="calibre23"><span class="calibre24">dval</span></tt></code> member of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Derived</span></tt></code>.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(d)</strong> Assign the value of the last element in <code class="calibre23"><tt class="calibre23"><span class="calibre24">MI::dvec</span></tt></code> to <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base2::fval</span></tt></code>.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(e)</strong> Assign <code class="calibre23"><tt class="calibre23"><span class="calibre24">cval</span></tt></code> from <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base1</span></tt></code> to the first character in <code class="calibre23"><tt class="calibre23"><span class="calibre24">sval</span></tt></code> from <code class="calibre23"><tt class="calibre23"><span class="calibre24">Derived</span></tt></code>.</p></blockquote><div class="calibre15">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<div class="calibre35"><blockquote class="calibre26"><a id="filepos5068799"/><hr class="calibre34"/><blockquote class="calibre13"><p class="calibre14"><span class="calibre5"><a/>Code for Exercises to Section 18.3.3</span></p></blockquote><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">struct Base1 {<br class="calibre6"/>&#160;&#160;&#160;&#160;void print(int) const;&#160;&#160;&#160;&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">by default</span></span></span><br class="calibre6"/>protected:<br class="calibre6"/>&#160;&#160;&#160;&#160;int&#160;&#160;&#160;&#160;ival;<br class="calibre6"/>&#160;&#160;&#160;&#160;double dval;<br class="calibre6"/>&#160;&#160;&#160;&#160;char&#160;&#160;&#160;cval;<br class="calibre6"/>private:<br class="calibre6"/>&#160;&#160;&#160;&#160;int&#160;&#160;&#160;&#160;*id;<br class="calibre6"/>};<br class="calibre6"/>struct Base2 {<br class="calibre6"/>&#160;&#160;&#160;&#160;void print(double) const;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">by default</span></span></span><br class="calibre6"/>protected:<br class="calibre6"/>&#160;&#160;&#160;&#160;double&#160;&#160;fval;<br class="calibre6"/>private:<br class="calibre6"/>&#160;&#160;&#160;&#160;double&#160;&#160;dval;<br class="calibre6"/>};<br class="calibre6"/>struct Derived : public Base1 {<br class="calibre6"/>&#160;&#160;&#160;&#160;void print(std::string) const;&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">by default</span></span></span><br class="calibre6"/>protected:<br class="calibre6"/>&#160;&#160;&#160;&#160;std::string sval;<br class="calibre6"/>&#160;&#160;&#160;&#160;double&#160;&#160;&#160;&#160;&#160;&#160;dval;<br class="calibre6"/>};<br class="calibre6"/>struct MI : public Derived, public Base2 {<br class="calibre6"/>&#160;&#160;&#160;&#160;void print(std::vector&lt;double&gt;); // <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">by default</span></span></span><br class="calibre6"/>protected:<br class="calibre6"/>&#160;&#160;&#160;&#160;int&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;*ival;<br class="calibre6"/>&#160;&#160;&#160;&#160;std::vector&lt;double&gt;&#160;&#160;dvec;<br class="calibre6"/>};</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<h4 id="filepos5071122" class="calibre37"><span class="calibre5">18.3.4. Virtual Inheritance</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">Although the derivation list of a class may not include the same base class more than once, a class can inherit from the same base class more than once. It might inherit the same base indirectly from two of its own direct base classes, or it might inherit a particular class directly and indirectly through another of its base classes.</p><div class="calibre15">&#160;</div>
<p class="calibre25">As an example, the IO library <code class="calibre23"><tt class="calibre23"><span class="calibre24">istream</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">ostream</span></tt></code> classes each inherit from a common abstract base class named <code class="calibre23"><tt class="calibre23"><span class="calibre24">basic_ios</span></tt></code>. That class holds the stream&#8217;s buffer and manages the stream&#8217;s condition state. The class <code class="calibre23"><tt class="calibre23"><span class="calibre24">iostream</span></tt></code>, which can both read and write to a stream, inherits directly from both <code class="calibre23"><tt class="calibre23"><span class="calibre24">istream</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">ostream</span></tt></code>. Because both types inherit from <code class="calibre23"><tt class="calibre23"><span class="calibre24">basic_ios</span></tt></code>, <code class="calibre23"><tt class="calibre23"><span class="calibre24">iostream</span></tt></code> inherits that base class twice, once through <code class="calibre23"><tt class="calibre23"><span class="calibre24">istream</span></tt></code> and once through <code class="calibre23"><tt class="calibre23"><span class="calibre24">ostream</span></tt></code>.</p><div class="calibre22">&#160;</div>
<p class="calibre25">By default, a derived object contains a separate subpart corresponding to each class in its derivation chain. If the same base class appears more than once in the derivation, then the derived object will have more than one subobject of that type.</p><div class="calibre22">&#160;</div>
<p class="calibre25">This default doesn&#8217;t work for a class such as <code class="calibre23"><tt class="calibre23"><span class="calibre24">iostream</span></tt></code>. An <code class="calibre23"><tt class="calibre23"><span class="calibre24">iostream</span></tt></code> object <a id="filepos5073319"/>wants to use the same buffer for both reading and writing, and it wants its condition state to reflect both input and output operations. If an <code class="calibre23"><tt class="calibre23"><span class="calibre24">iostream</span></tt></code> object has two copies of its <code class="calibre23"><tt class="calibre23"><span class="calibre24">basic_ios</span></tt></code> class, this sharing isn&#8217;t possible.</p><div class="calibre22">&#160;</div>
<p class="calibre25">In C++ we solve this kind of problem by using <strong class="calibre5"><a id="filepos5073804" href="175-defined_terms.html#filepos5120968">virtual inheritance</a></strong>. Virtual inheritance lets a class specify that it is willing to share its base class. The shared base-class subobject is called a <strong class="calibre5"><a id="filepos5074015" href="175-defined_terms.html#filepos5120267">virtual base class</a></strong>. Regardless of how often the same virtual base appears in an inheritance hierarchy, the derived object contains only one, shared subobject for that virtual base class.</p><div class="calibre22">&#160;</div>
<h5 class="calibre39"><span class="calibre5">A Different <code class="calibre23"><tt class="calibre23"><span class="calibre49"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Panda</span></span></tt></span></span></tt></code> Class</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">In the past, there was some debate as to whether panda belongs to the raccoon or the bear family. To reflect this debate, we can change <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> to inherit from both <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code>. To avoid giving <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> two <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> base parts, we&#8217;ll define <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code> to inherit virtually from <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>. <a href="173-18.3._multiple_and_virtual_inheritance.html#filepos5075458">Figure 18.3</a> illustrates our new hierarchy.</p><div class="calibre15">&#160;</div>
<div class="calibre52"><a id="filepos5075458"/><img alt="Image" src="images/00135.jpg" class="calibre9"/></div><div class="calibre22">&#160;</div>
<p class="calibre51"><span class="calibre5">Figure 18.3. Virtual Inheritance <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Panda</span></span></tt></span></span></tt></code> Hierarchy</span></p><div class="calibre12">&#160;</div>
<p class="calibre25">Looking at our new hierarchy, we&#8217;ll notice a nonintuitive aspect of virtual inheritance. The virtual derivation has to be made before the need for it appears. For example, in our classes, the need for virtual inheritance arises only when we define <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code>. However, if <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code> had not specified <code class="calibre23"><tt class="calibre23"><span class="calibre24">virtual</span></tt></code> on their derivation from <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>, the designer of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> class would be out of luck.</p><div class="calibre22">&#160;</div>
<p class="calibre25">In practice, the requirement that an intermediate base class specify its inheritance as virtual rarely causes any problems. Ordinarily, a class hierarchy that uses virtual inheritance is designed at one time either by one individual or by a single project design group. It is exceedingly rare for a class to be developed independently that needs a virtual base in one of its base classes and in which the developer of the new base class cannot change the existing hierarchy.</p><div class="calibre22">&#160;</div>
<div class="calibre33"><blockquote class="calibre26"><hr class="calibre34"/><p class="calibre14"><span class="calibre5"><a/><img alt="Image" src="images/00012.jpg" class="calibre9"/> Note</span></p><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre14">Virtual derivation affects the classes that subsequently derive from a class with a virtual base; it doesn&#8217;t affect the derived class itself.</p></blockquote><div class="calibre22">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<h5 class="calibre39"><span class="calibre5"><a id="filepos5077680"/>Using a Virtual Base Class</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">We specify that a base class is virtual by including the keyword <code class="calibre23"><tt class="calibre23"><span class="calibre24">virtual</span></tt></code> in the derivation list:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">// <span><span class="calibre45"><span class="calibre16">the order of the keywords</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">and</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">virtual</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">is not significant</span></span></span><br class="calibre6"/>class Raccoon : public virtual ZooAnimal { /* ... */ };<br class="calibre6"/>class Bear : virtual public ZooAnimal { /* ... */ };</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">Here we&#8217;ve made <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> a virtual base class of both <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code>.</p><div class="calibre15">&#160;</div>
<p class="calibre25">The <code class="calibre23"><tt class="calibre23"><span class="calibre24">virtual</span></tt></code> specifier states a willingness to share a single instance of the named base class within a subsequently derived class. There are no special constraints on a class used as a virtual base class.</p><div class="calibre22">&#160;</div>
<p class="calibre25">We do nothing special to inherit from a class that has a virtual base:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class Panda : public Bear,<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;public Raccoon, public Endangered {<br class="calibre6"/>};</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">Here <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> inherits <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> through both its <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> base classes. However, because those classes inherited virtually from <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal, Panda</span></tt></code> has only one <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> base subpart.</p><div class="calibre15">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Normal Conversions to Base Are Supported</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">An object of a derived class can be manipulated (as usual) through a pointer or a reference to an accessible base-class type regardless of whether the base class is virtual. For example, all of the following <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> base-class conversions are legal:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">void dance(const Bear&amp;);<br class="calibre6"/>void rummage(const Raccoon&amp;);<br class="calibre6"/>ostream&amp; operator&lt;&lt;(ostream&amp;, const ZooAnimal&amp;);<br class="calibre6"/>Panda ying_yang;<br class="calibre6"/>dance(ying_yang);&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">ok: passes</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">object as a</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Bear</span></span></tt></span><br class="calibre6"/>rummage(ying_yang); // <span><span class="calibre45"><span class="calibre16">ok: passes</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">object as a</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Raccoon</span></span></tt></span><br class="calibre6"/>cout &lt;&lt; ying_yang;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">ok: passes</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Panda</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">object as a</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">ZooAnimal</span></span></tt></span></span></tt></p></blockquote><div class="calibre22">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Visibility of Virtual Base-Class Members</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">Because there is only one shared subobject corresponding to each shared virtual base, members in that base can be accessed directly and unambiguously. Moreover, if a member from the virtual base is overridden along only one derivation path, then that overridden member can still be accessed directly. If the member is overridden by more than one base, then the derived class generally must define its own version as well.</p><div class="calibre15">&#160;</div>
<p class="calibre25">For example, assume class <code class="calibre23"><tt class="calibre23"><span class="calibre24">B</span></tt></code> defines a member named <code class="calibre23"><tt class="calibre23"><span class="calibre24">x</span></tt></code>; class <code class="calibre23"><tt class="calibre23"><span class="calibre24">D1</span></tt></code> inherits virtually from <code class="calibre23"><tt class="calibre23"><span class="calibre24">B</span></tt></code> as does class <code class="calibre23"><tt class="calibre23"><span class="calibre24">D2;</span></tt></code> and class <code class="calibre23"><tt class="calibre23"><span class="calibre24">D</span></tt></code> inherits from <code class="calibre23"><tt class="calibre23"><span class="calibre24">D1</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">D2</span></tt></code>. From the scope of <code class="calibre23"><tt class="calibre23"><span class="calibre24">D</span></tt></code>, <code class="calibre23"><tt class="calibre23"><span class="calibre24">x</span></tt></code> is visible through both of its base classes. If we use <code class="calibre23"><tt class="calibre23"><span class="calibre24">x</span></tt></code> through a <code class="calibre23"><tt class="calibre23"><span class="calibre24">D</span></tt></code> object, there are three possibilities:</p><div class="calibre22">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; If <code class="calibre23"><tt class="calibre23"><span class="calibre24">x</span></tt></code> is not defined in either <code class="calibre23"><tt class="calibre23"><span class="calibre24">D1</span></tt></code> or <code class="calibre23"><tt class="calibre23"><span class="calibre24">D2</span></tt></code> it will be resolved as a member in <code class="calibre23"><tt class="calibre23"><span class="calibre24">B</span></tt></code>; there is no ambiguity. A <code class="calibre23"><tt class="calibre23"><span class="calibre24">D</span></tt></code> object contains only one instance of <code class="calibre23"><tt class="calibre23"><span class="calibre24">x</span></tt></code>.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27"><a id="filepos5084926"/>&#8226; If <code class="calibre23"><tt class="calibre23"><span class="calibre24">x</span></tt></code> is a member of <code class="calibre23"><tt class="calibre23"><span class="calibre24">B</span></tt></code> and also a member in one, but not both, of <code class="calibre23"><tt class="calibre23"><span class="calibre24">D1</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">D2</span></tt></code>, there is again no ambiguity&#8212;the version in the derived class is given precedence over the shared virtual base class, <code class="calibre23"><tt class="calibre23"><span class="calibre24">B</span></tt></code>.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; If <code class="calibre23"><tt class="calibre23"><span class="calibre24">x</span></tt></code> is defined in both <code class="calibre23"><tt class="calibre23"><span class="calibre24">D1</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">D2</span></tt></code>, then direct access to that member is ambiguous.</p></blockquote><div class="calibre15">&#160;</div>
<p class="calibre14">As in a nonvirtual multiple inheritance hierarchy, ambiguities of this sort are best resolved by the derived class providing its own instance of that member.</p><div class="calibre15">&#160;</div>
<div class="calibre42"><blockquote class="calibre26"><hr class="calibre34"/><blockquote class="calibre13"><p class="calibre43"><span class="calibre5">Exercises Section 18.3.4</span></p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.28:</strong> Given the following class hierarchy, which inherited members can be accessed without qualification from within the <code class="calibre23"><tt class="calibre23"><span class="calibre24">VMI</span></tt></code> class? Which require qualification? Explain your reasoning.</p></blockquote><div class="calibre10">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">struct Base {<br class="calibre6"/>&#160;&#160;&#160;&#160;void bar(int);&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">by default</span></span></span><br class="calibre6"/>protected:<br class="calibre6"/>&#160;&#160;&#160;&#160;int ival;<br class="calibre6"/>};<br class="calibre6"/>struct Derived1 : virtual public Base {<br class="calibre6"/>&#160;&#160;&#160;&#160;void bar(char);&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">by default</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;void foo(char);<br class="calibre6"/>protected:<br class="calibre6"/>&#160;&#160;&#160;&#160;char cval;<br class="calibre6"/>};<br class="calibre6"/>struct Derived2 : virtual public Base {<br class="calibre6"/>&#160;&#160;&#160;&#160;void foo(int);&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">public</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">by default</span></span></span><br class="calibre6"/>protected:<br class="calibre6"/>&#160;&#160;&#160;&#160;int&#160;&#160;ival;<br class="calibre6"/>&#160;&#160;&#160;&#160;char cval;<br class="calibre6"/>};<br class="calibre6"/>class VMI : public Derived1, public Derived2 { };</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<h4 id="filepos5088013" class="calibre37"><span class="calibre5">18.3.5. Constructors and Virtual Inheritance</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">In a virtual derivation, the virtual base is initialized by the <em class="calibre16">most derived constructor</em>. In our example, when we create a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> constructor alone controls how the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> base class is initialized.</p><div class="calibre15">&#160;</div>
<p class="calibre25">To understand this rule, consider what would happen if normal initialization rules applied. In that case, a virtual base class might be initialized more than once. It would be initialized along each inheritance path that contains that virtual base. In our <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> example, if normal initialization rules applied, both <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code> would initialize the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> part of a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object.</p><div class="calibre22">&#160;</div>
<p class="calibre25">Of course, each class in the hierarchy might at some point be the &#8220;most derived&#8221; object. As long as we can create independent objects of a type derived from <a id="filepos5089580"/>a virtual base, the constructors in that class must initialize its virtual base. For example, in our hierarchy, when a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> (or a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code>) object is created, there is no further derived type involved. In this case, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> (or <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code>) constructors directly initialize their <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> base as usual:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Bear::Bear(std::string name, bool onExhibit):<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ZooAnimal(name, onExhibit, "Bear") { }<br class="calibre6"/>Raccoon::Raccoon(std::string name, bool onExhibit)<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;: ZooAnimal(name, onExhibit, "Raccoon") { }</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre25">When a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> is created, it is the most derived type and controls initialization of the shared <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> base. Even though <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> is not a direct base of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code>, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> constructor initializes <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Panda::Panda(std::string name, bool onExhibit)<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;: ZooAnimal(name, onExhibit, "Panda"),<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Bear(name, onExhibit),<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Raccoon(name, onExhibit),<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Endangered(Endangered::critical),<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;sleeping_flag(false)&#160;&#160;&#160;{ }</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<h5 class="calibre39"><span class="calibre5">How a Virtually Inherited Object Is Constructed</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">The construction order for an object with a virtual base is slightly modified from the normal order: The virtual base subparts of the object are initialized first, using initializers provided in the constructor for the most derived class. Once the virtual base subparts of the object are constructed, the direct base subparts are constructed in the order in which they appear in the derivation list.</p><div class="calibre15">&#160;</div>
<p class="calibre25">For example, when a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> object is created:</p><div class="calibre22">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; The (virtual base class) <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> part is constructed first, using the initializers specified in the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> constructor initializer list.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; The <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code> part is constructed next.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; The <code class="calibre23"><tt class="calibre23"><span class="calibre24">Raccoon</span></tt></code> part is constructed next.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; The third direct base, <code class="calibre23"><tt class="calibre23"><span class="calibre24">Endangered</span></tt></code>, is constructed next.</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre27">&#8226; Finally, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> part is constructed.</p></blockquote><div class="calibre15">&#160;</div>
<p class="calibre25">If the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Panda</span></tt></code> constructor does not explicitly initialize the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> base class, then the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> default constructor is used. If <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> doesn&#8217;t have a default constructor, then the code is in error.</p><div class="calibre22">&#160;</div>
<div class="calibre33"><blockquote class="calibre26"><hr class="calibre34"/><p class="calibre14"><span class="calibre5"><a/><img alt="Image" src="images/00012.jpg" class="calibre9"/> Note</span></p><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre14">Virtual base classes are always constructed prior to nonvirtual base classes regardless of where they appear in the inheritance hierarchy.</p></blockquote><div class="calibre22">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<h5 class="calibre39"><span class="calibre5">Constructor and Destructor Order</span></h5><div class="calibre38">&#160;</div>
<p class="calibre14">A class can have more than one virtual base class. In that case, the virtual subobjects are constructed in left-to-right order as they appear in the derivation list. For <a id="filepos5095425"/>example, in the following whimsical <code class="calibre23"><tt class="calibre23"><span class="calibre24">TeddyBear</span></tt></code> derivation, there are two virtual base classes: <code class="calibre23"><tt class="calibre23"><span class="calibre24">ToyAnimal</span></tt></code>, a direct virtual base, and <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code>, which is a virtual base class of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Bear</span></tt></code>:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class Character { /* ... */ };<br class="calibre6"/>class BookCharacter : public Character { /* ... */ };<br class="calibre6"/><br class="calibre6"/>class ToyAnimal { /* ... */ };<br class="calibre6"/><br class="calibre6"/>class TeddyBear : public BookCharacter,<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;public Bear, public virtual ToyAnimal<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{ /* ... */ };</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre25">The direct base classes are examined in declaration order to determine whether there are any virtual base classes. If so, the virtual bases are constructed first, followed by the nonvirtual base-class constructors in declaration order. Thus, to create a <code class="calibre23"><tt class="calibre23"><span class="calibre24">TeddyBear</span></tt></code>, the constructors are invoked in the following order:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">ZooAnimal();&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Bear'</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s virtual base class</span></span></span><br class="calibre6"/>ToyAnimal();&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">direct virtual base class</span></span></span><br class="calibre6"/>Character();&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">indirect base class of first nonvirtual base class</span></span></span><br class="calibre6"/>BookCharacter();&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">first direct nonvirtual base class</span></span></span><br class="calibre6"/>Bear();&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">second direct nonvirtual base class</span></span></span><br class="calibre6"/>TeddyBear();&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">most derived class</span></span></span></span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre25">The same order is used in the synthesized copy and move constructors, and members are assigned in this order in the synthesized assignment operators. As usual, an object is destroyed in reverse order from which it was constructed. The <code class="calibre23"><tt class="calibre23"><span class="calibre24">TeddyBear</span></tt></code> part will be destroyed first and the <code class="calibre23"><tt class="calibre23"><span class="calibre24">ZooAnimal</span></tt></code> part last.</p><div class="calibre22">&#160;</div>
<div class="calibre42"><blockquote class="calibre26"><hr class="calibre34"/><blockquote class="calibre13"><p class="calibre43"><span class="calibre5">Exercises Section 18.3.5</span></p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.29:</strong> Given the following class hierarchy:</p></blockquote><div class="calibre10">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class Class { ... };<br class="calibre6"/>class Base : public Class { ... };<br class="calibre6"/>class D1 : virtual public Base { ... };<br class="calibre6"/>class D2 : virtual public Base { ... };<br class="calibre6"/>class MI : public D1, public D2 { ... };<br class="calibre6"/>class Final : public MI, public Class { ... };</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(a)</strong> In what order are constructors and destructors run on a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Final</span></tt></code> object?</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(b)</strong> A <code class="calibre23"><tt class="calibre23"><span class="calibre24">Final</span></tt></code> object has how many <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base</span></tt></code> parts? How many <code class="calibre23"><tt class="calibre23"><span class="calibre24">Class</span></tt></code> parts?</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(c)</strong> Which of the following assignments is a compile-time error?</p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Base *pb;&#160;&#160;&#160;&#160;Class *pc;&#160;&#160;&#160;&#160;&#160;&#160;&#160;MI *pmi;&#160;&#160;&#160;&#160;&#160;D2 *pd2;</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(a)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">pb = new Class;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(b)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">pc = new Final;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(c)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">pmi = pb;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre26"><p class="calibre53"><strong class="calibre5">(d)</strong>
<code class="calibre23"><tt class="calibre23"><span class="calibre24">pd2 = pmi;</span></tt></code></p></blockquote><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 18.30:</strong> Define a default constructor, a copy constructor, and a constructor that has an <code class="calibre23"><tt class="calibre23"><span class="calibre24">int</span></tt></code> parameter in <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base</span></tt></code>. Define the same three constructors in each derived class. Each constructor should use its argument to initialize its <code class="calibre23"><tt class="calibre23"><span class="calibre24">Base</span></tt></code> part.</p></blockquote><div class="calibre10">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="001-contents.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href="172-18.2._namespaces.html"><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href="174-chapter_summary.html"><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a></div></td></tr></table></body></html>
