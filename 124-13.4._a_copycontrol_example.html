<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>13.4. A Copy-Control Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" type="text/css" rel="stylesheet"/>
<link href="page_styles.css" type="text/css" rel="stylesheet"/>
</head>
  <body class="calibre">
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="001-contents.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href="123-13.3._swap.html"><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href="125-13.5._classes_that_manage_dynamic_memory.html"><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a></div></td></tr></table><h3 id="filepos3341274" class="calibre29"><span class="bold">13.4. A Copy-Control Example</span></h3><div class="calibre12">&#160;</div>
<p class="calibre14">Although copy control is most often needed for classes that allocate resources, resource management is not the only reason why a class might need to define these members. Some classes have bookkeeping or other actions that the copy-control members must perform.</p><div class="calibre15">&#160;</div>
<p class="calibre25">As an example of a class that needs copy control in order to do some bookkeeping, we&#8217;ll sketch out two classes that might be used in a mail-handling application. These classes, <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>, represent, respectively, email (or other kinds <a id="filepos3342107"/>of) messages, and directories in which a message might appear. Each <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> can appear in multiple <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s. However, there will be only one copy of the contents of any given <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>. That way, if the contents of a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> are changed, those changes will appear when we view that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from any of its <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s.</p><div class="calibre22">&#160;</div>
<p class="calibre25">To keep track of which <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s are in which <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s, each <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> will store a <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> of pointers to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s in which it appears, and each <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> will contain a <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> of pointers to its <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s. <a href="124-13.4._a_copycontrol_example.html#filepos3343680">Figure 13.1</a> illustrates this design.</p><div class="calibre22">&#160;</div>
<div class="calibre52"><a id="filepos3343680"/><img alt="Image" src="images/00097.jpg" class="calibre9"/></div><div class="calibre22">&#160;</div>
<p class="calibre51"><span class="calibre5">Figure 13.1. <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Message</span></span></tt></span></span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Folder</span></span></tt></span></span></tt></code> Class Design</span></p><div class="calibre12">&#160;</div>
<p class="calibre25">Our <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> class will provide <code class="calibre23"><tt class="calibre23"><span class="calibre24">save</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove</span></tt></code> operations to add or remove a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from a specified <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>. To create a new <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, we will specify the contents of the message but no <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>. To put a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> in a particular <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>, we must call <code class="calibre23"><tt class="calibre23"><span class="calibre24">save</span></tt></code>.</p><div class="calibre22">&#160;</div>
<p class="calibre25">When we copy a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, the copy and the original will be distinct <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s, but both <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s should appear in the same <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s. Thus, copying a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> will copy the contents and the <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> pointers. It must also add a pointer to the newly created <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> to each of those <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s.</p><div class="calibre22">&#160;</div>
<p class="calibre25">When we destroy a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> no longer exists. Therefore, destroying a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> must remove pointers to that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s that had contained that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>.</p><div class="calibre22">&#160;</div>
<p class="calibre25">When we assign one <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> to another, we&#8217;ll replace the <code class="calibre23"><tt class="calibre23"><span class="calibre24">contents</span></tt></code> of the left-hand <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> with those in the right-hand side. We must also update the <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s, removing the left-hand <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from its previous <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s and adding that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s in which the right-hand <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> appears.</p><div class="calibre22">&#160;</div>
<p class="calibre25">Looking at this list of operations, we can see that both the destructor and the copy-assignment operator have to remove this <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s that point to it. Similarly, both the copy constructor and the copy-assignment operator add a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> to a given list of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s. We&#8217;ll define a pair of <code class="calibre23"><tt class="calibre23"><span class="calibre24">private</span></tt></code> utility functions to do these tasks.</p><div class="calibre22">&#160;</div>
<div class="calibre33"><blockquote class="calibre26"><hr class="calibre34"/><p class="calibre14"><span class="calibre5"><a/><img alt="Image" src="images/00017.jpg" class="calibre9"/> Best Practices</span></p><div class="calibre15">&#160;</div>
<blockquote class="calibre13"><p class="calibre14">The copy-assignment operator often does the same work as is needed in the copy constructor and destructor. In such cases, the common work should be put in <code class="calibre23"><tt class="calibre23"><span class="calibre24">private</span></tt></code> utility functions.</p></blockquote><div class="calibre22">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<p class="calibre25"><a id="filepos3349047"/>The <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> class will need analogous copy control members to add or remove itself from the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s it stores.</p><div class="calibre22">&#160;</div>
<p class="calibre25">We&#8217;ll leave the design and implementation of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> class as an exercise. However, we&#8217;ll assume that the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> class has members named <code class="calibre23"><tt class="calibre23"><span class="calibre24">addMsg</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">remMsg</span></tt></code> that do whatever work is need to add or remove this <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, respectively, from the set of messages in the given <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>.</p><div class="calibre22">&#160;</div>
<h4 class="calibre37"><span class="calibre5">The <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Message</span></span></tt></span></span></tt></code> Class</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">Given this design, we can write our <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> class as follows:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">class Message {<br class="calibre6"/>&#160;&#160;&#160;&#160;friend class Folder;<br class="calibre6"/>public:<br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">folders</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">is implicitly initialized to the empty</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">set</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;explicit Message(const std::string &amp;str = ""):<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;contents(str) { }<br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">copy control to manage pointers to this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;Message(const Message&amp;);&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">copy constructor</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;Message&amp; operator=(const Message&amp;); // <span><span class="calibre45"><span class="calibre16">copy assignment</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;~Message();&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">destructor</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">add/remove this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">from the specified</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">'s set of messages</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;void save(Folder&amp;);<br class="calibre6"/>&#160;&#160;&#160;&#160;void remove(Folder&amp;);<br class="calibre6"/>private:<br class="calibre6"/>&#160;&#160;&#160;&#160;std::string contents;&#160;&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">actual message text</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;std::set&lt;Folder*&gt; folders; // <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s that have this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">utility functions used by copy constructor, assignment, and destructor</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">add this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s that point to the parameter</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;void add_to_Folders(const Message&amp;);<br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">remove this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">from every</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">in</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">folders</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;void remove_from_Folders();<br class="calibre6"/>};</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">The class defines two data members: <code class="calibre23"><tt class="calibre23"><span class="calibre24">contents</span></tt></code>, to store the message text, and <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code>, to store pointers to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s in which this <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> appears. The constructor that takes a <code class="calibre23"><tt class="calibre23"><span class="calibre24">string</span></tt></code> copies the given <code class="calibre23"><tt class="calibre23"><span class="calibre24">string</span></tt></code> into <code class="calibre23"><tt class="calibre23"><span class="calibre24">contents</span></tt></code> and (implicitly) initializes <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code> to the empty set. Because this constructor has a default argument, it is also the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> default constructor (&#167; <a href="077-7.5._constructors_revisited.html#filepos1953073">7.5.1</a>, p. <a href="077-7.5._constructors_revisited.html#filepos1953073">290</a>).</p><div class="calibre15">&#160;</div>
<h4 class="calibre37"><span class="calibre5">The <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">save</span></span></tt></span></span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">remove</span></span></tt></span></span></tt></code> Members</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">Aside from copy control, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> class has only two <code class="calibre23"><tt class="calibre23"><span class="calibre24">public</span></tt></code> members: <code class="calibre23"><tt class="calibre23"><span class="calibre24">save</span></tt></code>, which puts the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> in the given <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>, and <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove</span></tt></code>, which takes it out:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">void Message::save(Folder &amp;f)<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;folders.insert(&amp;f); // <span><span class="calibre45"><span class="calibre16">add the given</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to our list of</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;f.addMsg(this);&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">add this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">f</span></span></tt></span><span><span class="calibre45"><span class="calibre16">'s set of</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>}<br class="calibre6"/><a id="filepos3357587"/><br class="calibre6"/>void Message::remove(Folder &amp;f)<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;folders.erase(&amp;f); // <span><span class="calibre45"><span class="calibre16">take the given</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">out of our list of</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;f.remMsg(this);&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">remove this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">f</span></span></tt></span><span><span class="calibre45"><span class="calibre16">'s set of</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">To save (or remove) a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> requires updating the <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code> member of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>. When we <code class="calibre23"><tt class="calibre23"><span class="calibre24">save</span></tt></code> a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, we store a pointer to the given <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>; when we <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove</span></tt></code> a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, we remove that pointer.</p><div class="calibre15">&#160;</div>
<p class="calibre25">These operations must also update the given <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>. Updating a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> is a job that the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> class controls through its <code class="calibre23"><tt class="calibre23"><span class="calibre24">addMsg</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">remMsg</span></tt></code> members, which will add or remove a pointer to a given <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, respectively.</p><div class="calibre22">&#160;</div>
<h4 class="calibre37"><span class="calibre5">Copy Control for the <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Message</span></span></tt></span></span></tt></code> Class</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">When we copy a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>, the copy should appear in the same <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s as the original <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>. As a result, we must traverse the <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> pointers adding a pointer to the new <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> to each <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> that points to the original <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>. Both the copy constructor and the copy-assignment operator will need to do this work, so we&#8217;ll define a function to do this common processing:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">// <span><span class="calibre45"><span class="calibre16">add this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s that point to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">m</span></span></tt></span><br class="calibre6"/>void Message::add_to_Folders(const Message &amp;m)<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;for (auto f : m.folders) // <span><span class="calibre45"><span class="calibre16">for each</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">that holds</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">m</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;f-&gt;addMsg(this); // <span><span class="calibre45"><span class="calibre16">add a pointer to this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to that</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">Here we call <code class="calibre23"><tt class="calibre23"><span class="calibre24">addMsg</span></tt></code> on each <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> in <code class="calibre23"><tt class="calibre23"><span class="calibre24">m.folders</span></tt></code>. The <code class="calibre23"><tt class="calibre23"><span class="calibre24">addMsg</span></tt></code> function will add a pointer to this <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> to that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>.</p><div class="calibre15">&#160;</div>
<p class="calibre25">The <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> copy constructor copies the data members of the given object:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Message::Message(const Message &amp;m):<br class="calibre6"/>&#160;&#160;&#160;&#160;contents(m.contents), folders(m.folders)<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;add_to_Folders(m); // <span><span class="calibre45"><span class="calibre16">add this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s that point to</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">m</span></span></tt></span><br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">and calls <code class="calibre23"><tt class="calibre23"><span class="calibre24">add_to_Folders</span></tt></code> to add a pointer to the newly created <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> to each <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> that contains the original <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>.</p><div class="calibre15">&#160;</div>
<h4 class="calibre37"><span class="calibre5">The <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Message</span></span></tt></span></span></tt></code> Destructor</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">When a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> is destroyed, we must remove this <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s that point to it. This work is shared with the copy-assignment operator, so we&#8217;ll define a common function to do it:</p><div class="calibre15">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">// <span><span class="calibre45"><span class="calibre16">remove this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">from the corresponding</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>void Message::remove_from_Folders()<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;for (auto f : folders) // <span><span class="calibre45"><span class="calibre16">for each pointer in</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">folders</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;f-&gt;remMsg(this);&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">remove this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">from that</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14"><a id="filepos3366946"/>The implementation of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove_from_Folders</span></tt></code> function is similar to that of <code class="calibre23"><tt class="calibre23"><span class="calibre24">add_to_Folders</span></tt></code>, except that it uses <code class="calibre23"><tt class="calibre23"><span class="calibre24">remMsg</span></tt></code> to remove the current <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>.</p><div class="calibre15">&#160;</div>
<p class="calibre25">Given the <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove_from_Folders</span></tt></code> function, writing the destructor is trivial:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Message::~Message()<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;remove_from_Folders();<br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">The call to <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove_from_Folders</span></tt></code> ensures that no <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> has a pointer to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> we are destroying. The compiler automatically invokes the <code class="calibre23"><tt class="calibre23"><span class="calibre24">string</span></tt></code> destructor to free <code class="calibre23"><tt class="calibre23"><span class="calibre24">contents</span></tt></code> and the <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> destructor to clean up the memory used by those members.</p><div class="calibre15">&#160;</div>
<h4 class="calibre37"><span class="calibre5"><code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Message</span></span></tt></span></span></tt></code> Copy-Assignment Operator</span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">In common with most assignment operators, our <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> copy-assignment operator must do the work of the copy constructor and the destructor. As usual, it is crucial that we structure our code to execute correctly even if the left- and right-hand operands happen to be the same object.</p><div class="calibre15">&#160;</div>
<p class="calibre25">In this case, we protect against self-assignment by removing pointers to this <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from the <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code> of the left-hand operand before inserting pointers in the <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code> in the right-hand operand:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"/></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">Message&amp; Message::operator=(const Message &amp;rhs)<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">handle self-assignment by removing pointers before inserting them</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;remove_from_Folders();&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">update existing</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;contents = rhs.contents; // <span><span class="calibre45"><span class="calibre16">copy message contents from</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">rhs</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;folders = rhs.folders;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">copy</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">pointers from</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">rhs</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;add_to_Folders(rhs);&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">add this</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to those</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;return *this;<br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<p class="calibre14">If the left- and right-hand operands are the same object, then they have the same address. Had we called <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove_from_folders</span></tt></code> after calling <code class="calibre23"><tt class="calibre23"><span class="calibre24">add_to_folders</span></tt></code>, we would have removed this <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> from all of its corresponding <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s.</p><div class="calibre15">&#160;</div>
<h4 class="calibre37"><span class="calibre5">A <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">swap</span></span></tt></span></span></tt></code> Function for <code class="calibre23"><tt class="calibre23"><span class="calibre24"><span><tt class="calibre23"><span class="calibre32"><span class="calibre5">Message</span></span></tt></span></span></tt></code></span></h4><div class="calibre38">&#160;</div>
<p class="calibre14">The library defines versions of <code class="calibre23"><tt class="calibre23"><span class="calibre24">swap</span></tt></code> for both <code class="calibre23"><tt class="calibre23"><span class="calibre24">string</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> (&#167; <a href="090-9.2._container_library_overview.html#filepos2239281">9.2.5</a>, p. <a href="090-9.2._container_library_overview.html#filepos2239281">339</a>). As a result, our <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> class will benefit from defining its own version of <code class="calibre23"><tt class="calibre23"><span class="calibre24">swap</span></tt></code>. By defining a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>-specific version of <code class="calibre23"><tt class="calibre23"><span class="calibre24">swap</span></tt></code>, we can avoid extraneous copies of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">contents</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code> members.</p><div class="calibre15">&#160;</div>
<p class="calibre25">However, our <code class="calibre23"><tt class="calibre23"><span class="calibre24">swap</span></tt></code> function must also manage the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> pointers that point to the swapped <code class="calibre23"><tt class="calibre23"><span class="calibre24">Messages</span></tt></code>. After a call such as <code class="calibre23"><tt class="calibre23"><span class="calibre24">swap(m1, m2)</span></tt></code>, the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s that had pointed to <code class="calibre23"><tt class="calibre23"><span class="calibre24">m1</span></tt></code> must now point to <code class="calibre23"><tt class="calibre23"><span class="calibre24">m2</span></tt></code>, and vice versa.</p><div class="calibre22">&#160;</div>
<p class="calibre25">We&#8217;ll manage the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> pointers by making two passes through each of the <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code> members. The first pass will remove the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s from their respective <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>s. We&#8217;ll next call <code class="calibre23"><tt class="calibre23"><span class="calibre24">swap</span></tt></code> to swap the data members. We&#8217;ll make the second pass through <code class="calibre23"><tt class="calibre23"><span class="calibre24">folder</span></tt></code>s this time adding pointers to the swapped <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s:</p><div class="calibre22">&#160;</div>
<p class="calibre40"><span class="calibre41"><span class="calibre5"><a id="filepos3375038"/></span></span></p><div class="calibre38">&#160;</div>
<blockquote class="calibre13"><p class="calibre31"><tt class="calibre23"><span class="calibre24">void swap(Message &amp;lhs, Message &amp;rhs)<br class="calibre6"/>{<br class="calibre6"/>&#160;&#160;&#160;&#160;using std::swap; // <span><span class="calibre45"><span class="calibre16">not strictly needed in this case, but good habit</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">remove pointers to each</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">from their (original) respective</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;for (auto f: lhs.folders)<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;f-&gt;remMsg(&amp;lhs);<br class="calibre6"/>&#160;&#160;&#160;&#160;for (auto f: rhs.folders)<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;f-&gt;remMsg(&amp;rhs);<br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">swap the</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">contents</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">and</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">pointer</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">set</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;swap(lhs.folders, rhs.folders);&#160;&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">uses</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">swap(set&amp;, set&amp;)</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;swap(lhs.contents, rhs.contents);&#160;&#160;&#160;// <span><tt class="calibre23"><span class="calibre46"><span class="calibre16">swap(string&amp;, string&amp;)</span></span></tt></span><br class="calibre6"/>&#160;&#160;&#160;&#160;// <span><span class="calibre45"><span class="calibre16">add pointers to each</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Message</span></span></tt></span>
<span><span class="calibre45"><span class="calibre16">to their (new) respective</span></span></span>
<span><tt class="calibre23"><span class="calibre46"><span class="calibre16">Folder</span></span></tt></span><span><span class="calibre45"><span class="calibre16">s</span></span></span><br class="calibre6"/>&#160;&#160;&#160;&#160;for (auto f: lhs.folders)<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;f-&gt;addMsg(&amp;lhs);<br class="calibre6"/>&#160;&#160;&#160;&#160;for (auto f: rhs.folders)<br class="calibre6"/>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;f-&gt;addMsg(&amp;rhs);<br class="calibre6"/>}</span></tt></p></blockquote><div class="calibre22">&#160;</div>
<div class="calibre42"><blockquote class="calibre26"><hr class="calibre34"/><blockquote class="calibre13"><p class="calibre43"><span class="calibre5">Exercises Section 13.4</span></p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 13.33:</strong> Why is the parameter to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">save</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">remove</span></tt></code> members of <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> a <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder&amp;?</span></tt></code> Why didn&#8217;t we define that parameter as <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>? Or <code class="calibre23"><tt class="calibre23"><span class="calibre24">const Folder&amp;?</span></tt></code></p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 13.34:</strong> Write the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> class as described in this section.</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 13.35:</strong> What would happen if <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> used the synthesized versions of the copy-control members?</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 13.36:</strong> Design and implement the corresponding <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code> class. That class should hold a <code class="calibre23"><tt class="calibre23"><span class="calibre24">set</span></tt></code> that points to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code>s in that <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>.</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 13.37:</strong> Add members to the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> class to insert or remove a given <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder*</span></tt></code> into <code class="calibre23"><tt class="calibre23"><span class="calibre24">folders</span></tt></code>. These members are analogous to <code class="calibre23"><tt class="calibre23"><span class="calibre24">Folder</span></tt></code>&#8217;s <code class="calibre23"><tt class="calibre23"><span class="calibre24">addMsg</span></tt></code> and <code class="calibre23"><tt class="calibre23"><span class="calibre24">remMsg</span></tt></code> operations.</p></blockquote><div class="calibre10">&#160;</div>
<blockquote class="calibre13"><p class="calibre44"><a/><strong class="calibre5">Exercise 13.38:</strong> We did not use copy and swap to define the <code class="calibre23"><tt class="calibre23"><span class="calibre24">Message</span></tt></code> assignment operator. Why do you suppose this is so?</p></blockquote><div class="calibre10">&#160;</div>
<hr class="calibre34"/></blockquote></div><div class="calibre3">&#160;</div>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr><td><div STYLE="MARGIN-LEFT: 0.15in;"><a href="001-contents.html"><img src="images/teamlib.gif" width="62" height="15" border="0" align="absmiddle"  alt="Team LiB"></a></div></td><td align="right"><div STYLE="MARGIN-LEFT: 0.15in;">
<a href="123-13.3._swap.html"><img src="images/previous.gif" width="62" height="15" border="0" align="absmiddle" alt="Previous Section"></a>
<a href="125-13.5._classes_that_manage_dynamic_memory.html"><img src="images/next.gif" width="41" height="15" border="0" align="absmiddle" alt="Next Section"></a></div></td></tr></table></body></html>
